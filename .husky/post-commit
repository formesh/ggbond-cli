#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# æ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨å‘å¸ƒ (è®¾ç½®ç¯å¢ƒå˜é‡ AUTO_PUBLISH=true æ¥å¯ç”¨)
if [ "$AUTO_PUBLISH" != "true" ]; then
  echo "â„¹ï¸  è‡ªåŠ¨å‘å¸ƒå·²ç¦ç”¨ã€‚è¦å¯ç”¨è¯·è®¾ç½®: export AUTO_PUBLISH=true"
  exit 0
fi

# æ£€æŸ¥æ˜¯å¦æ˜¯ä¸»åˆ†æ”¯çš„æäº¤
if [ "$(git branch --show-current)" = "main" ] || [ "$(git branch --show-current)" = "master" ]; then
  echo "ğŸš€ æ£€æµ‹åˆ°ä¸»åˆ†æ”¯æäº¤ï¼Œå¼€å§‹è‡ªåŠ¨å‘å¸ƒæµç¨‹..."
  
  # è¿›å…¥CLIåŒ…ç›®å½•
  cd packages/cli
  
  # æ£€æŸ¥package.jsonæ˜¯å¦æœ‰ç‰ˆæœ¬å˜æ›´
  if git diff HEAD~1 HEAD --name-only | grep -q "packages/cli/package.json"; then
    echo "ğŸ“¦ æ£€æµ‹åˆ°package.jsonå˜æ›´ï¼Œå¼€å§‹æ„å»ºå’Œå‘å¸ƒ..."
    
    # æ„å»ºé¡¹ç›®
    echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
    pnpm build
    
    if [ $? -eq 0 ]; then
      # å‘å¸ƒåˆ°npm
      echo "ğŸ“¤ å‘å¸ƒåˆ°npm..."
      npm publish
      
      if [ $? -eq 0 ]; then
        echo "âœ… è‡ªåŠ¨å‘å¸ƒå®Œæˆï¼"
      else
        echo "âŒ npmå‘å¸ƒå¤±è´¥"
        exit 1
      fi
    else
      echo "âŒ æ„å»ºå¤±è´¥ï¼Œè·³è¿‡å‘å¸ƒ"
      exit 1
    fi
  else
    echo "â„¹ï¸  æœªæ£€æµ‹åˆ°package.jsonç‰ˆæœ¬å˜æ›´ï¼Œè·³è¿‡å‘å¸ƒ"
  fi
else
  echo "â„¹ï¸  éä¸»åˆ†æ”¯æäº¤ï¼Œè·³è¿‡è‡ªåŠ¨å‘å¸ƒ"
fi