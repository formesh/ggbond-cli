#!/usr/bin/env node

import { Command } from 'commander';
import prompts from 'prompts';
import { join, dirname } from 'path';
import { readFileSync, writeFileSync, mkdirSync, existsSync, cpSync } from 'fs';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// è¯»å– package.json è·å–ç‰ˆæœ¬ä¿¡æ¯
const packageJsonPath = join(__dirname, '../package.json');
const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf-8'));

const program = new Command();

program
  .name('ggbond')
  .description('GGBond CLI - ä¸€ä¸ªå¼ºå¤§çš„é¡¹ç›®è„šæ‰‹æ¶å·¥å…·')
  .version(packageJson.version);

// init å‘½ä»¤ - é¡¹ç›®ç”Ÿæˆ
program
  .command('init')
  .description('åˆå§‹åŒ–ä¸€ä¸ªæ–°é¡¹ç›®')
  .argument('[project-name]', 'é¡¹ç›®åç§°')
  .option('-t, --template <template>', 'é¡¹ç›®æ¨¡æ¿ç±»å‹', 'basic')
  .action(async (projectName, options) => {
    try {
      await initProject(projectName, options);
    } catch (error) {
      console.error('âŒ é¡¹ç›®åˆå§‹åŒ–å¤±è´¥:', error instanceof Error ? error.message : String(error));
      process.exit(1);
    }
  });

// build å‘½ä»¤ - é¡¹ç›®æ‰“åŒ…
program
  .command('build')
  .description('æ„å»ºé¡¹ç›®')
  .option('-e, --env <environment>', 'æ„å»ºç¯å¢ƒ', 'production')
  .option('-o, --output <dir>', 'è¾“å‡ºç›®å½•', 'dist')
  .action(async (options) => {
    try {
      await buildProject(options);
    } catch (error) {
      console.error('âŒ é¡¹ç›®æ„å»ºå¤±è´¥:', error instanceof Error ? error.message : String(error));
      process.exit(1);
    }
  });

// dev å‘½ä»¤ - å¼€å‘æœåŠ¡å™¨
program
  .command('dev')
  .description('å¯åŠ¨å¼€å‘æœåŠ¡å™¨')
  .option('-p, --port <port>', 'ç«¯å£å·', '3000')
  .option('-h, --host <host>', 'ä¸»æœºåœ°å€', 'localhost')
  .action(async (options) => {
    try {
      await startDevServer(options);
    } catch (error) {
      console.error('âŒ å¼€å‘æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error instanceof Error ? error.message : String(error));
      process.exit(1);
    }
  });

// é¡¹ç›®åˆå§‹åŒ–å‡½æ•°
async function initProject(projectName: string, options: any) {
  let name = projectName;
  
  // å¦‚æœæ²¡æœ‰æä¾›é¡¹ç›®åç§°ï¼Œé€šè¿‡äº¤äº’å¼æç¤ºè·å–
  if (!name) {
    const response = await prompts({
      type: 'text',
      name: 'projectName',
      message: 'è¯·è¾“å…¥é¡¹ç›®åç§°:',
      validate: (value) => value.trim() ? true : 'é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©º'
    });
    
    if (!response.projectName) {
      console.log('âŒ æ“ä½œå·²å–æ¶ˆ');
      return;
    }
    
    name = response.projectName;
  }
  
  // é€‰æ‹©é¡¹ç›®æ¨¡æ¿
  const templateResponse = await prompts({
    type: 'select',
    name: 'template',
    message: 'é€‰æ‹©é¡¹ç›®æ¨¡æ¿:',
    choices: [
      { title: 'React + TypeScript', value: 'react-ts' },
      { title: 'Vue + TypeScript', value: 'vue-ts' },
      { title: 'Node.js + Express', value: 'node-express' },
      { title: 'Basic TypeScript', value: 'basic-ts' }
    ],
    initial: 0
  });
  
  if (!templateResponse.template) {
    console.log('âŒ æ“ä½œå·²å–æ¶ˆ');
    return;
  }
  
  console.log(`ğŸš€ æ­£åœ¨åˆ›å»ºé¡¹ç›®: ${name}`);
  console.log(`ğŸ“¦ ä½¿ç”¨æ¨¡æ¿: ${templateResponse.template}`);
  
  // åˆ›å»ºé¡¹ç›®ç›®å½•
  const projectPath = join(process.cwd(), name);
  
  if (existsSync(projectPath)) {
    const overwrite = await prompts({
      type: 'confirm',
      name: 'overwrite',
      message: `ç›®å½• ${name} å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`,
      initial: false
    });
    
    if (!overwrite.overwrite) {
      console.log('âŒ æ“ä½œå·²å–æ¶ˆ');
      return;
    }
  }
  
  mkdirSync(projectPath, { recursive: true });
  
  // ç”Ÿæˆé¡¹ç›®æ–‡ä»¶
  await generateProjectFiles(projectPath, name, templateResponse.template);
  
  console.log('âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸ!');
  console.log(`\nğŸ“ é¡¹ç›®è·¯å¾„: ${projectPath}`);
  console.log('\nğŸ¯ ä¸‹ä¸€æ­¥:');
  console.log(`   cd ${name}`);
  console.log('   npm install');
  console.log('   npm run dev');
}

// ç”Ÿæˆé¡¹ç›®æ–‡ä»¶
async function generateProjectFiles(projectPath: string, projectName: string, template: string) {
  // åˆ›å»º package.json
  const packageJson: any = {
    name: projectName,
    version: '1.0.0',
    description: `${projectName} - Generated by GGBond CLI`,
    main: 'index.js',
    scripts: {
      dev: 'echo "å¼€å‘æœåŠ¡å™¨å¯åŠ¨ä¸­..."',
      build: 'echo "é¡¹ç›®æ„å»ºä¸­..."',
      start: 'echo "é¡¹ç›®å¯åŠ¨ä¸­..."'
    },
    keywords: [],
    author: '',
    license: 'MIT'
  };
  
  // æ ¹æ®æ¨¡æ¿æ·»åŠ ç‰¹å®šä¾èµ–
  switch (template) {
    case 'react-ts':
      packageJson.scripts = {
        dev: 'vite',
        build: 'tsc && vite build',
        preview: 'vite preview'
      };
      break;
    case 'vue-ts':
      packageJson.scripts = {
        dev: 'vite',
        build: 'vue-tsc && vite build',
        preview: 'vite preview'
      };
      break;
    case 'node-express':
      packageJson.scripts = {
        dev: 'nodemon src/index.js',
        build: 'echo "Node.jsé¡¹ç›®æ— éœ€æ„å»º"',
        start: 'node src/index.js'
      };
      break;
  }
  
  writeFileSync(
    join(projectPath, 'package.json'),
    JSON.stringify(packageJson, null, 2)
  );
  
  // åˆ›å»º README.md
  const readme = `# ${projectName}

${packageJson.description}

## å®‰è£…ä¾èµ–

\`\`\`bash
npm install
\`\`\`

## å¼€å‘

\`\`\`bash
npm run dev
\`\`\`

## æ„å»º

\`\`\`bash
npm run build
\`\`\`

## å¯åŠ¨

\`\`\`bash
npm start
\`\`\`
`;
  
  writeFileSync(join(projectPath, 'README.md'), readme);
  
  // åˆ›å»º .gitignore
  const gitignore = `node_modules/
dist/
build/
.env
.env.local
.DS_Store
*.log
`;
  
  writeFileSync(join(projectPath, '.gitignore'), gitignore);
  
  // æ ¹æ®æ¨¡æ¿åˆ›å»ºç‰¹å®šæ–‡ä»¶
  await createTemplateFiles(projectPath, template);
}

// åˆ›å»ºæ¨¡æ¿ç‰¹å®šæ–‡ä»¶
async function createTemplateFiles(projectPath: string, template: string) {
  const srcPath = join(projectPath, 'src');
  mkdirSync(srcPath, { recursive: true });
  
  switch (template) {
    case 'react-ts':
      // åˆ›å»ºåŸºæœ¬çš„ React + TypeScript æ–‡ä»¶
      writeFileSync(join(srcPath, 'App.tsx'), `import React from 'react';

function App() {
  return (
    <div className="App">
      <h1>Hello GGBond CLI!</h1>
      <p>React + TypeScript é¡¹ç›®æ¨¡æ¿</p>
    </div>
  );
}

export default App;
`);
      break;
      
    case 'vue-ts':
      // åˆ›å»ºåŸºæœ¬çš„ Vue + TypeScript æ–‡ä»¶
      writeFileSync(join(srcPath, 'App.vue'), `<template>
  <div id="app">
    <h1>Hello GGBond CLI!</h1>
    <p>Vue + TypeScript é¡¹ç›®æ¨¡æ¿</p>
  </div>
</template>

<script setup lang="ts">
// Vue 3 Composition API with TypeScript
</script>

<style>
#app {
  font-family: Avenir, Helvetica, Arial, sans-serif;
  text-align: center;
  margin-top: 60px;
}
</style>
`);
      break;
      
    case 'node-express':
      // åˆ›å»ºåŸºæœ¬çš„ Node.js + Express æ–‡ä»¶
      writeFileSync(join(srcPath, 'index.js'), `const express = require('express');
const app = express();
const port = process.env.PORT || 3000;

app.get('/', (req, res) => {
  res.json({
    message: 'Hello GGBond CLI!',
    description: 'Node.js + Express é¡¹ç›®æ¨¡æ¿'
  });
});

app.listen(port, () => {
  console.log(\`ğŸš€ æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:\${port}\`);
});
`);
      break;
      
    case 'basic-ts':
      // åˆ›å»ºåŸºæœ¬çš„ TypeScript æ–‡ä»¶
      writeFileSync(join(srcPath, 'index.ts'), `console.log('Hello GGBond CLI!');
console.log('Basic TypeScript é¡¹ç›®æ¨¡æ¿');

// ç¤ºä¾‹å‡½æ•°
function greet(name: string): string {
  return \`Hello, \${name}!\`;
}

console.log(greet('GGBond'));
`);
      break;
  }
}

// é¡¹ç›®æ„å»ºå‡½æ•°
async function buildProject(options: any) {
  console.log(`ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®...`);
  console.log(`ğŸ“¦ æ„å»ºç¯å¢ƒ: ${options.env}`);
  console.log(`ğŸ“ è¾“å‡ºç›®å½•: ${options.output}`);

  try {
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ package.json
    if (!existsSync('package.json')) {
      throw new Error('å½“å‰ç›®å½•ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é¡¹ç›®ç›®å½•ï¼ˆç¼ºå°‘ package.jsonï¼‰');
    }

    // æ‰§è¡Œæ„å»ºå‘½ä»¤
    console.log('âš¡ æ‰§è¡Œæ„å»ºå‘½ä»¤...');
    execSync('npm run build', { stdio: 'inherit' });

    console.log('âœ… é¡¹ç›®æ„å»ºå®Œæˆ!');
  } catch (error) {
    throw new Error(`æ„å»ºå¤±è´¥: ${error instanceof Error ? error.message : String(error)}`);
  }
}

// å¼€å‘æœåŠ¡å™¨å‡½æ•°
async function startDevServer(options: any) {
  console.log(`ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...`);
  console.log(`ğŸŒ åœ°å€: http://${options.host}:${options.port}`);
  
  try {
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ package.json
    if (!existsSync('package.json')) {
      throw new Error('å½“å‰ç›®å½•ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é¡¹ç›®ç›®å½•ï¼ˆç¼ºå°‘ package.jsonï¼‰');
    }
    
    // è®¾ç½®ç¯å¢ƒå˜é‡
    process.env.PORT = options.port;
    process.env.HOST = options.host;
    
    // æ‰§è¡Œå¼€å‘å‘½ä»¤
    console.log('âš¡ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...');
    execSync('npm run dev', { stdio: 'inherit' });
    
  } catch (error) {
    throw new Error(`å¼€å‘æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: ${error instanceof Error ? error.message : String(error)}`);
  }
}

// è§£æå‘½ä»¤è¡Œå‚æ•°
program.parse();